 TextDocumentContentProvider:æ„å»ºè™šæ‹Ÿæ–‡æ¡£ç³»ç»Ÿï¼ˆå¦‚ `git://` åè®®æ–‡ä»¶ï¼‰ã€‚

### ä»€ä¹ˆæ˜¯è™šæ‹Ÿæ–‡æ¡£ï¼Ÿ
- è™šæ‹Ÿæ–‡æ¡£ä¸æ˜¯ç‰©ç†ç£ç›˜ä¸Šçš„çœŸå®æ–‡ä»¶
- ç”±æ’ä»¶åŠ¨æ€ç”Ÿæˆå†…å®¹ï¼ˆå¦‚ Git å†å²ç‰ˆæœ¬ã€æ•°æ®åº“æŸ¥è¯¢ç»“æœã€API å“åº”ç­‰ï¼‰
- ä½¿ç”¨è‡ªå®šä¹‰ URI åè®®ï¼ˆå¦‚ `git://`, `myapp://`ï¼‰

### å·¥ä½œæµç¨‹
```typescript
// æ³¨å†Œ git åè®®çš„ Content Provider
vscode.workspace.registerTextDocumentContentProvider(
    'git',  // ğŸ‘ˆ åè®®æ ‡è¯†ç¬¦
    gitProvider  // å†…å®¹æä¾›å™¨å®ä¾‹
  //è¿™è¡Œä»£ç å»ºç«‹äº† git:// åè®®ä¸ GitHistoryProvider å®ä¾‹çš„å…³è”
);
```

### 2. å®ç°TextDocumentContentProvider

```ts
// å‡½æ•°å¼å®ç°
const gitProvider: vscode.TextDocumentContentProvider = {
    provideTextDocumentContent(uri) {
        return `# Virtual Document\nURI: ${uri.toString()}`;
    }
};

// æ›´ç®€æ´çš„ç®­å¤´å‡½æ•°å¼
const createSimpleProvider = (contentFn: (uri: vscode.Uri) => string): vscode.TextDocumentContentProvider => ({
    provideTextDocumentContent: contentFn
});

// ä½¿ç”¨ç¤ºä¾‹
vscode.workspace.registerTextDocumentContentProvider(
    'simple',
    createSimpleProvider(uri => `Content for ${uri.path}`)
);
```



```typescript
class GitHistoryProvider implements vscode.TextDocumentContentProvider {
    // å†…å®¹å˜æ›´äº‹ä»¶ï¼ˆç”¨äºæ›´æ–°æ–‡æ¡£ï¼‰
    private _onDidChange = new vscode.EventEmitter<vscode.Uri>();
    readonly onDidChange = this._onDidChange.event;

    // æ ¸å¿ƒæ–¹æ³•:æä¾›æ–‡æ¡£å†…å®¹
    async provideTextDocumentContent(uri: vscode.Uri): Promise<string> {
        // è§£æ URI å‚æ•°:git://path/to/file.js?commit=abc123
        const filePath = uri.path;
        const commitHash = uri.query.split('=')[1];
        
        // è·å– Git å†å²å†…å®¹ï¼ˆå®é™…å¼€å‘ä¸­åº”è°ƒç”¨ Git å‘½ä»¤ï¼‰
        const content = await this.getGitFileContent(filePath, commitHash);
        
        // è¿”å›å¸¦è¯­æ³•é«˜äº®çš„ Markdown
        return `# Git å†å²ç‰ˆæœ¬: ${commitHash}\n\`\`\`${this.getLanguageId(filePath)}\n${content}\n\`\`\``;
    }

    private async getGitFileContent(path: string, commit: string): Promise<string> {
        // æ¨¡æ‹Ÿä» Git è·å–æ–‡ä»¶å†…å®¹
        return `// æ–‡ä»¶: ${path}\n// æäº¤: ${commit}\n// å†…å®¹æ¥è‡ª Git å†å²ç‰ˆæœ¬\nconsole.log("Hello Git History!");`;
    }

    private getLanguageId(path: string): string {
        // æ ¹æ®æ–‡ä»¶æ‰©å±•åè¿”å›è¯­è¨€ ID
        const ext = path.split('.').pop() || '';
        return ({ js: 'javascript', ts: 'typescript', py: 'python' })[ext] || '';
    }

    // æ›´æ–°æ–‡æ¡£çš„æ–¹æ³•ï¼ˆå¯è¢«å¤–éƒ¨è°ƒç”¨ï¼‰
    public update(uri: vscode.Uri) {
        this._onDidChange.fire(uri);
    }

    dispose() {
        this._onDidChange.dispose();
    }
}
```

### 3. æ‰“å¼€è™šæ‹Ÿæ–‡æ¡£
```typescript
// åœ¨å‘½ä»¤ä¸­æ‰“å¼€è™šæ‹Ÿæ–‡æ¡£
vscode.commands.registerCommand('extension.showGitHistory', async () => {
    const activeEditor = vscode.window.activeTextEditor;
    if (!activeEditor) return;
    
    const uri = activeEditor.document.uri;
    const commitHash = 'abc123'; // å®é™…åº”ä» Git è·å–
    
    // åˆ›å»ºè™šæ‹Ÿ URI: git://file.js?commit=abc123
    const gitUri = vscode.Uri.parse(`git:${uri.path}?commit=${commitHash}`);
    
    // æ‰“å¼€è™šæ‹Ÿæ–‡æ¡£
    const doc = await vscode.workspace.openTextDocument(gitUri);
    await vscode.window.showTextDocument(doc, { preview: false });
});
```

### 4. åœ¨ package.json ä¸­æ³¨å†Œå‘½ä»¤
```json
"contributes": {
    "commands": [{
        "command": "extension.showGitHistory",
        "title": "æŸ¥çœ‹ Git å†å²"
    }]
}
```

## é«˜çº§ç”¨æ³•ä¸æŠ€å·§

### 1. åŠ¨æ€æ›´æ–°æ–‡æ¡£å†…å®¹
```typescript
// å½“éœ€è¦æ›´æ–°æ–‡æ¡£æ—¶
gitProvider.update(gitUri);

// åœ¨ Provider ä¸­è§¦å‘æ›´æ–°
public refreshDocument(uri: vscode.Uri) {
    this._onDidChange.fire(uri);
}
```

### 2. å¤„ç†å¤§æ–‡ä»¶/å¼‚æ­¥åŠ è½½
```typescript
async provideTextDocumentContent(uri: vscode.Uri): Promise<string> {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const loadingMsg = "åŠ è½½Gitå†å²å†…å®¹...";
    this.updateContent(uri, loadingMsg); // è¾…åŠ©æ–¹æ³•æ›´æ–°å†…å®¹
    
    try {
        const content = await this.fetchGitContent(uri);
        return content;
    } catch (error) {
        return `# é”™è¯¯\næ— æ³•åŠ è½½å†…å®¹: ${error.message}`;
    }
}

private updateContent(uri: vscode.Uri, content: string) {
    // å®ç°ä¸´æ—¶å†…å®¹æ›´æ–°é€»è¾‘
}
```

### 3. è‡ªå®šä¹‰æ–‡æ¡£äº¤äº’
```typescript
// åœ¨æ–‡æ¡£ä¸­æ·»åŠ å¯æ“ä½œçš„æŒ‰é’®
return `# Git å†å²ç‰ˆæœ¬
[<< ä¸Šä¸€ä¸ªç‰ˆæœ¬](command:extension.prevGitVersion?${encodeURIComponent(JSON.stringify({uri: uri.toString()}))})
[ä¸‹ä¸€ä¸ªç‰ˆæœ¬ >>](command:extension.nextGitVersion?${encodeURIComponent(...)})

\`\`\`javascript
${fileContent}
\`\`\``;
```

## ä¸ onDidOpenTextDocument çš„é›†æˆ

### ç›‘å¬è™šæ‹Ÿæ–‡æ¡£æ‰“å¼€
```typescript
vscode.workspace.onDidOpenTextDocument(doc => {
    if (doc.uri.scheme === 'git') {
        console.log(`æ‰“å¼€ Git å†å²æ–‡æ¡£: ${doc.uri}`);
        // å¯åœ¨æ­¤æ‰§è¡Œç›¸å…³åˆå§‹åŒ–
    }
});
```

### é‡è¦é™åˆ¶
- **æ— æ³•é˜»æ­¢æ‰“å¼€**:`onDidOpenTextDocument` è§¦å‘æ—¶æ–‡æ¡£å·²æ‰“å¼€
- **å†…å®¹æ§åˆ¶**:æ–‡æ¡£å†…å®¹ç”± Provider å®Œå…¨æ§åˆ¶
- **çŠ¶æ€ç®¡ç†**:è™šæ‹Ÿæ–‡æ¡£ä¸ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ç£ç›˜

## å…¸å‹åº”ç”¨åœºæ™¯

1. **ç‰ˆæœ¬æ§åˆ¶å†å²**:Git/SVN æ–‡ä»¶å†å²æŸ¥çœ‹
2. **æ•°æ®åº“å†…å®¹**:æ˜¾ç¤º SQL æŸ¥è¯¢ç»“æœ
3. **API æ–‡æ¡£**:åŠ¨æ€ç”Ÿæˆçš„ REST API æ–‡æ¡£
4. **é…ç½®é¢„è§ˆ**:æ˜¾ç¤ºç¼–è¯‘åçš„é…ç½®ç»“æœ
5. **å®æ—¶æ•°æ®**:ç›‘æ§æ—¥å¿—æˆ–å®æ—¶æ•°æ®æµ

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å†…å®¹ç¼“å­˜**:ç¼“å­˜å·²è·å–çš„å†…å®¹é¿å…é‡å¤è®¡ç®—
2. **å¢é‡åŠ è½½**:å¯¹å¤§æ–‡ä»¶å®ç°åˆ†é¡µåŠ è½½
3. **æ‡’åŠ è½½**:ä»…åœ¨éœ€è¦æ—¶åŠ è½½å†…å®¹
4. **å–æ¶ˆæ”¯æŒ**:æ­£ç¡®å¤„ç† `CancellationToken`
5. **äº‹ä»¶èŠ‚æµ**:é¿å…é¢‘ç¹è§¦å‘ `onDidChange`

`TextDocumentContentProvider` æ˜¯æ„å»ºé«˜çº§ VS Code æ’ä»¶çš„å…³é”®å·¥å…·ï¼Œé€šè¿‡åˆ›å»ºè™šæ‹Ÿæ–‡æ¡£ç³»ç»Ÿï¼Œä½ å¯ä»¥æ‰©å±• VS Code çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›æ— ç¼çš„å®šåˆ¶ä½“éªŒã€‚